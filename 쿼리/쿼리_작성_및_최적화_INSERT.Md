# ***쿼리 작성 및 최적화***  

## `INSERT` 
많은 INSERT 문장이 동시에 실행되는 경우 INSERT 문장 자체보다는 테이블의 구조가 성능에 더 큰 영향을 미친다.  

#### `INSERT IGNORE`  
레코드의 프라이머리 키나 유니크 인덱스 컬럼의 값이 이미 테이블에 존재하는 레코드와 중복되는 경우,  
그리고 저장하는 레코드의 컬럼이 테이블의 컬럼과 호환되지 않는 경우 모두 무시하고 다음 레코드를 처리한다.  
MYSQL 내부적으로 에러를 경고 수준의 메시지로 바꾸고 나머지 레코드의 INSERT를 진행한다.  


#### `INSERT...ON DUPLICATE KEY UPDATE`  
유니크 인덱스의 중복이 발생하면 UPDATE 문장의 역할을 수행하게 해준다.  
REPLACE도 유사해 보이지만 DELETE 와 UPDATE의 조합이다.  

일별로 집계되는 통계 데이터를 INSERT 할때 사용 예제
```
INSERT INTO daily_statistic 
    SELECT DATE(visited_at), 'VISIT', COUNT(*)
    FROM access_log
    GROUP BY DATE(visited_at)
    ON DUPLICATE KEY UPDATE stat_value=stat_value + VALUES(stat_value);
```

## `LOAD DATA`  
MYSQL 엔진과 스토리지 엔진의 호출 횟수를 초과하고 스토리지 엔진이 직접 데이터를 적재하기 때문에 일반 INSERT 보다 매우 빠르다.
하지만 단점은 단일 스레드, 단일 트랜잭션 실행 방식이다.  

테이블에 여러 인덱스가 있다면 레코드를 INSERT 하고 인덱스에도 키 값을 INSERT 해야한다.  
테이블에 레코드가 INSERT 될수록 인덱스의 크기도 커진다.  
단일 스레드로 동작하기 때문에 시간이 지날수록 INSERT 속도가 현저히 떨어진다.  

또한, 단일 트랜잭션 이기 때문에 언두 로그가 삭제되지 못하고 유지돼야 한다.  
언두 로그가 많이 쌓이면 레코드를 읽는 쿼리들이 필요한 레코드를 찾는데 더 많은 오버헤드가 발생한다.  
가능하다면 적재할 데이터 파일을 하나보다는 여러 개의 파일로 준비해서 동시에 여러 트랜잭션으로 나뉘어 실행되게 하는 것이 좋다.  
테이블간 복사 작업이라면 LOAD DATA 보다는 INSERT...SELECT... 문장으로 WHERE 절에서 데이터를 부분적으로 잘라서 INSERT 하는 것이 좋다.  
프라이머리 키 값을 기준으로 데이터를 잘라서 여러 개의 스레드로 실행하기가 용이하기 때문이다.  
  

## `성능을 위한 테이블 구조`  
##### 대량 INSERT 성능  
프라이머리 키로 정렬 되어있는 데이터의 속도가 훨씬 빠르다.  
- 프라이머리 키가 직전 INSERT된 값보다 항상 크기 때문에 새로운 페이지를 메모미로 가져오지 않아도 레코드를 저장할 위치를 찾을 수 있다.  

InnoDB 스토리지 엔진을 사용하는 테이블의 프라이머리 키는 클러스터링 키인데, 이는 세컨더리 인덱스를 이용하는 쿼리보다 프라이머리 키를 이용하는 쿼리의 성능이 훨씬 빨라지는 효과를 낸다.  
그래서 프라이머리 키는 단순히 INSERT 성능만을 위해 설계해서는 안된다.  
프라이머리 키의 선정은 INSERT 성능과 SELECT 성능의 대립되는 두 가지 요소 중에서 하나를 선택해야한다.  

대부분 온라인 트랜잭션 처리를 위한 테이블들은 쓰기보다 읽기 쿼리의 비율이 압도적으로 높다.  
반대로 SELECT는 많지 않고 INSERT가 많은 테이블에 대해서는 인덱스의 개수를 최소화하는 것이 좋다.  

#### SELECT 보다 INSERT가 많은 테이블 설계
- 단조 증가 또는 단조 감소되는 값으로 프라이머리 키 선정  
- 세컨더리 인덱스 최소화    

InnoDB 스토리지 엔진을 사용하는 테이블은 자동으로 프라이머리 키로 클러스터링 된다.  
즉, 프라이머리 키로 클러스터링되지 않게 InnoDB 테이블을 생성할 수 없다.  
하지만 자동 증가(Auto Increment) 컬럼을 이용하면 클러스터링되지 않는 테이블의 효과를 얻을 수 있다.  
자동 증가 값을 프라이머리 키로 테이블을 생성하는 것은 MYSQL에서 가장 빠른 INSERT를 보장하는 방법이다.  
세컨더리 인덱스가 하나도 없는 테이블이라면 금상첨화이다.  
